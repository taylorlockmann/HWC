---
title: "HWC Occurrence Data"
author: "Roshni Katrak-Adefowora"
date: "11/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load packages
library(tidyverse)
library(rgbif)
library(maptools)
library(dismo)
library(rgeos)
library(viridis)
#library(scrubr)
library(raster)
library(DHARMa)
library(spocc)
library(sf)
library(rgdal)
library(spData)
library(here)
library(lubridate)
library(kableExtra)

#install wallace
library(wallace)
#run_wallace()

#load Wallace functions
source(system.file('shiny/funcs', 'functions.R', package = 'wallace'))
```

# This does not need to be run again unless we're changing the input settings to create and thin our occurrence data. All occurrence results are saved as csv's and can be read in in the other Rmd.

## Description:

This markdown file outlines methods that can be used to create data for species distribution modeling (SDM) with the Maxent GUI.

The Maxent GUI can be run two different ways:

  1) Using samples with data (SWD) where you extract the climate data from the bioclim rasters for each occurrence and background point.
  
  2) Using lat/long for each point and the bioclim rasters.

### Download species occurence data and get coordinates

For both steps, you will need to begin by downloading the species occurrence points, which can be done 3 different ways 1) with the function from Wallace, 2) with the function from the rgbif packages, or 3) by downloading from gbif.org itself.

We chose to go forward with the function from Wallace.

#### 1) Download using Wallace's spocc:occ() function

Gives global records.  If limit is set high, this function can take a while to run. Choose chunk to run based on species.

African Lion
```{r}
results <- spocc::occ(query = "Panthera leo", # scientific name, here we are using lions
                      from = "gbif", # set to records from https://www.gbif.org/
                      limit = 15000, # max number of records
                      has_coords = TRUE) # gets the lat/long for each observation

# select just GBIF records, format the species name
results[["gbif"]]$data[[formatSpName("Panthera leo")]]

# select just the necessary information
myspecies_coords <- as.data.frame(results$gbif$data$Panthera_leo) %>% # using GBIF data
  dplyr::select(longitude, latitude, occurrenceStatus, coordinateUncertaintyInMeters, institutionCode, references, basisOfRecord, eventDate) %>%  # selecting just the columns that we want
  filter(!basisOfRecord %in% c("FOSSIL_SPECIMEN", "PRESERVED_SPECIMEN", "LIVING_SPECIMEN"),
         occurrenceStatus == "PRESENT")
        #eventDate <= "2010-12-31" & eventDate >= "1981-01-01") #change this depending on whether we're using all occurrence points, just 1970-2000 (for bioclim variables), or just 1981-2010 (for chelsa variables)
```

Savanna Elephant
```{r}
results <- spocc::occ(query = "Loxodonta africana (Blumenbach, 1797)", # scientific name, here we are using lions
                      from = "gbif", # set to records from https://www.gbif.org/
                      limit = 15000, # max number of records
                      has_coords = TRUE) # gets the lat/long for each observation

# select just GBIF records, format the species name
results[["gbif"]]$data[[formatSpName("Loxodonta africana")]]

# select just the necessary information
myspecies_coords <- as.data.frame(results$gbif$data$Loxodonta_africana) %>% # using GBIF data
  dplyr::select(longitude, latitude, occurrenceStatus, coordinateUncertaintyInMeters, institutionCode, references, basisOfRecord, eventDate) %>%  # selecting just the columns that we want
  filter(!basisOfRecord %in% c("FOSSIL_SPECIMEN", "PRESERVED_SPECIMEN", "LIVING_SPECIMEN"),
         occurrenceStatus == "PRESENT")
       # eventDate <= "2010-12-31" & eventDate >= "1981-01-01") #change this depending on whether we're using all occurrence points, just 1970-2000 (for bioclim variables), or just 1981-2010 (for chelsa variables)
```

Forest Elephant
```{r}
results <- spocc::occ(query = "Loxodonta cyclotis",
                      from = "gbif", # set to records from https://www.gbif.org/
                      limit = 15000, # max number of records
                      has_coords = TRUE) # gets the lat/long for each observation

results_2 <- spocc::occ(query = "Loxodonta africana subsp. cyclotis (Matschie, 1900)",
                      from = "gbif", # set to records from https://www.gbif.org/
                      limit = 15000, # max number of records
                      has_coords = TRUE) # gets the lat/long for each observation

# select just GBIF records, format the species name
results_1[["gbif"]]$data[[formatSpName("Loxodonta cyclotis")]]
results_2[["gbif"]]$data[[formatSpName("Loxodonta_africana_subsp_cyclotis")]]

# select just the necessary information
myspecies_coords_1 <- as.data.frame(results_1$gbif$data$Loxodonta_cyclotis) %>% # using GBIF data
  dplyr::select(longitude, latitude, occurrenceStatus, coordinateUncertaintyInMeters, institutionCode, references, basisOfRecord, eventDate) %>%  # selecting just the columns that we want
  filter(!basisOfRecord %in% c("FOSSIL_SPECIMEN", "PRESERVED_SPECIMEN", "LIVING_SPECIMEN"),
         occurrenceStatus == "PRESENT")
        #eventDate <= "2010-12-31" & eventDate >= "1981-01-01") #change this depending on whether we're using all occurrence points, just 1970-2000 (for bioclim variables), or just 1981-2010 (for chelsa variables)

myspecies_coords_2 <- as.data.frame(results_2$gbif$data$Loxodonta_cyclotis) # using GBIF data
  dplyr::select(longitude, latitude, occurrenceStatus, coordinateUncertaintyInMeters, institutionCode, references, basisOfRecord, eventDate) %>%  # selecting just the columns that we want
  filter(!basisOfRecord %in% c("FOSSIL_SPECIMEN", "PRESERVED_SPECIMEN", "LIVING_SPECIMEN"),
         occurrenceStatus == "PRESENT")
        #eventDate <= "2010-12-31" & eventDate >= "1981-01-01") #change this depending on whether we're using all occurrence points, just 1970-2000 (for bioclim variables), or just 1981-2010 (for chelsa variables)
```

### Clean Data

```{r}
# remove rows with duplicate coordinates
occs.dups <- duplicated(myspecies_coords[c('longitude', 'latitude')])
myspecies_coords <- myspecies_coords[!occs.dups,]

# make sure latitude and longitude are numeric (sometimes they are characters)
myspecies_coords$latitude <- as.numeric(myspecies_coords$latitude)
myspecies_coords$longitude <- as.numeric(myspecies_coords$longitude)

# give all records a unique ID
myspecies_coords$occID <- row.names(myspecies_coords)

# removing unlikely, imprecise, incomplete, and impossible coordinates - doesn't run
#occs <- coord_incomplete(coord_imprecise(coord_impossible(coord_unlikely(myspecies_coords))))

# # save lat/long points as a csv if needed
# occs_cleaned <- coord_incomplete(coord_imprecise(coord_impossible(coord_unlikely(myspecies_coords))))%>%
#   rename(lat = latitude) %>% # renaming lat/long so it works with projection later on?
#   rename(long = longitude)
# lat_long <- lion_cleaned %>% 
#   dplyr::select(lat, long)
# 
# write_csv(lat_long, "occs_cleaned_coords.csv")
```

### Crop data using Africa boundary

We decided to use a shapefile of Africa instead of selecting with a polygon on Wallace because it's easier and cleaner.

```{r}
#get spatial extent using Afrotropical ecoregion from WWF. Data downloaded from https://www.worldwildlife.org/publications/terrestrial-ecoregions-of-the-world
afrotropical_region <- read_sf(dsn = "H:/My Drive/HWC/R_files/R_input_data/wwf_ecoregions/official", layer = "wwf_terr_ecos") %>% 
  filter(REALM == "AT")

#check crs
crs(afrotropical_region) # +proj=longlat +datum=WGS84 +no_defs 

# create shapefile for wallace
# st_write(afrotropical_region, dsn = "H:/My Drive/HWC/R_files/R_output_data/afrotropical_region/afrotropical_region.shp", layer = "afrotropical_region.shp", driver = "ESRI Shapefile")

# load world data from spData package
world_sp <-  as(world, "Spatial")
world_sf <-  st_as_sf(world_sp, "sf")

# filter countries to just those in Africa (removing Madagascar)
africa <- world_sf %>% 
  filter(continent == "Africa") %>% 
  filter(name_long != "Madagascar") %>% 
  dplyr::select(name_long)

# merge all the country polygons to create one large continental polygon
africa_2 <- st_combine(africa)

# convert to a spatial polygon
africa_spatial <- as_Spatial(africa_2, cast = TRUE)

# creates new data frame with observation data lat/long points
occs.xy <- myspecies_coords[c('longitude', 'latitude')] #change occs to myspecies_coords for now since can't install "scrubr"

# convert species data to spatial layer
coordinates(occs.xy) <- ~longitude+latitude
projection(occs.xy) <- CRS('+proj=longlat +datum=WGS84')

# double-check that polygon and points have the same projection
crs(afrotropical_region) # +proj=longlat +datum=WGS84 +no_defs 
crs(occs.xy) # +proj=longlat +datum=WGS84 +no_defs 

# overlays those points over the polygon
intersect <- sp::over(occs.xy, afrotropical_region)
# could also use 
# raster::crop(occs.xy, africa_spatial)

# removes na values, so selects for points where they overlap the focal polygon
intersect.rowNums <- as.numeric(which(!(is.na(intersect))))

# filters our occurrence data to those overlapping points
occs <- myspecies_coords[intersect.rowNums, ] #again, change occs to myspecies_coords
occs$name <- "Loxodonta africana" #change depending on the species!
```

#### In case you want to create a map figure to double check everything
```{r}
# world map example

(data("wrld_simpl"))

# run plot and points function at once
plot(wrld_simpl, 
     xlim = range(occs$long),
     ylim = range(occs$lat), 
     axes = TRUE, 
     col = "light yellow"
     )
points(occs$longitude, occs$latitude, col = 'blue', pch = 20, cex = 0.75) #add the points
```

### Spatial thin

This will remove occurrence points that are within a specified distance from one-another, and is very important when dealing with areas that have a disproportionate amount of observations in a small area (like in wildlife reserves and parks, which we observe in Africa). It may not necessarily reflect that the climate in that area is ideally suited for that organism. For us, it may be a reflection of reduced human-impacts and an increase in reported occurrences by visitors.

```{r}
# just doing 10 replicates for now, thinning to 10 km
output <- spThin::thin(occs, 'latitude', 'longitude', 'name', 
                       thin.par = 10, # thinned to 10 km
                       reps = 10, # default on Wallace is 100, but run time is long, so a low number is good for testing
                       locs.thinned.list.return = TRUE, 
                       write.files = FALSE, 
                       verbose = FALSE)

# find the iteration that returns the max number of occurrences
maxThin <- which(sapply(output, nrow) == max(sapply(output, nrow)))

# if there's more than one max, pick the first one
maxThin <- output[[ifelse(length(maxThin) > 1, maxThin[1], maxThin)]]  

# subset data to those thinned records
occs <- occs[as.numeric(rownames(maxThin)),]

# save occs to upload to Wallace if needed
      occs_wallace <- occs %>% 
        dplyr::select(name, longitude, latitude) # change order to match
      write_csv(occs_wallace, "H:/My Drive/HWC/R_files/R_output_data/occurrence_points/sav_elephant_all_points_thinned.csv")
```


###Plot again (thinned points)

```{r}
# world map example

(data("wrld_simpl"))

# run plot and points function at once
plot(wrld_simpl, 
     xlim = range(occs$long),
     ylim = range(occs$lat), 
     axes = TRUE, 
     col = "light yellow"
     )
points(occs$longitude, occs$latitude, col = 'blue', pch = 20, cex = 0.75) #add the points
```

### Load worldclim data and afrotropical region

```{r}
#read in worldclim version 2 data
rastlist <- list.files(path = "H:/My Drive/HWC/R_files/R_input_data/wc2.1_2.5m_bio", pattern='.tif$', full.names=TRUE)
bioclim_data_v2 <- stack(rastlist)

#get spatial extent using Afrotropical ecoregion from WWF. Data downloaded from https://www.worldwildlife.org/publications/terrestrial-ecoregions-of-the-world
afrotropical_region <- read_sf(dsn = "H:/My Drive/HWC/R_files/R_input_data/wwf_ecoregions/official", layer = "wwf_terr_ecos") %>% 
  filter(REALM == "AT")

#check crs
crs(afrotropical_region) # +proj=longlat +datum=WGS84 +no_defs 

# create shapefile for wallace
# st_write(afrotropical_region, dsn = "H:/My Drive/HWC/R_files/R_output_data/afrotropical_region/afrotropical_region.shp", layer = "afrotropical_region.shp", driver = "ESRI Shapefile")

# cropping bioclim variables to extent of Africa spatial polygon
bioclim_crop <- raster::crop(bioclim_data_v2, afrotropical_region)

# double checking to see they line up
plot(bioclim_crop[[1]])
plot(buffer_points, add = TRUE)

# extract environmental values at occ grid cells
locs.vals <- raster::extract(bioclim_crop[[1]], occs[, c('longitude', 'latitude')])

bioclim_selected <- raster::subset(bioclim_crop, c("wc2.1_2.5m_bio_1", "wc2.1_2.5m_bio_2", "wc2.1_2.5m_bio_5", "wc2.1_2.5m_bio_6", "wc2.1_2.5m_bio_12", "wc2.1_2.5m_bio_13", "wc2.1_2.5m_bio_14"))

bioclim_selected_extract <- raster::extract(bioclim_crop[[1]], occs[, c('longitude', 'latitude')])
# remove occs without environmental values
occs_ <- occs[!is.na(bioclim_selected_extract), ]
```
